<!-- Inline JSON-LD per layout globale (Jekyll default.html) -->
{%- comment -%}
  Organization and WebSite JSON-LD are emitted by `jekyll-seo-tag` via `{% seo %}`.
  To avoid duplicate Organization/WebSite entities (and Rich Results warnings),
  this include now provides only page-scoped schema: WebPage, BreadcrumbList and
  CollectionPage (when relevant). BlogPosting is kept in `_includes/schema-blogposting.html`.
{%- endcomment -%}

<!-- WebPage Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "@id": "{{ page.url | absolute_url }}#webpage",
  "url": "{{ page.url | absolute_url }}",
  "name": "{{ page.title }}",
  "description": "{{ page.seo_description | default: page.description | default: page.excerpt | strip_html | truncate: 160 }}",
  "isPartOf": {
    "@id": "{{ site.url }}/#website"
  },
  "about": {
    "@id": "{{ site.url }}/#organization"
  },
  "datePublished": "{{ page.date | default: site.time | date_to_xmlschema }}",
  "dateModified": "{{ page.last_modified_at | default: page.date | default: site.time | date_to_xmlschema }}"
}
</script>

{% if page.layout == 'post' %}
{%- comment -%}
  BlogPosting schema removed from this global include to avoid duplication.
  Use `_includes/schema-blogposting.html` (included in `_layouts/post.html`) as the single BlogPosting source.
{%- endcomment -%}
{%- comment -%}
  Precompute canonical URLs to avoid inline nested filters that produced malformed values.
  category_url: prefer mapping from `site.data.category_slugs`, otherwise build from `site.url` + slugified category.
  subcluster_url: if subcluster present, append to category_url safely.
{%- endcomment -%}

{%- assign category_url = nil -%}
{%- assign subcluster_url = nil -%}
{%- if page.category or (page.categories and page.categories.first) or page.cluster or page.cluster_name -%}
    {%- assign category_key = nil -%}
    {%- if page.category and page.category != "" -%}
      {%- assign category_key = page.category -%}
    {%- elsif page.categories and page.categories.size > 0 -%}
      {%- assign category_key = page.categories[0] -%}
    {%- elsif page.cluster and page.cluster != "" -%}
      {%- assign category_key = page.cluster -%}
    {%- elsif page.cluster_name and page.cluster_name != "" -%}
      {%- assign category_key = page.cluster_name -%}
    {%- endif -%}
    {%- assign category_key = category_key | default: '' | downcase | slugify -%}
  {%- assign mapped = site.data.category_slugs[category_key] | default: nil -%}
  {%- if mapped -%}
    {%- assign category_url = mapped | absolute_url -%}
  {%- else -%}
  {%- assign category_path = '/categorie/' | append: category_key | append: '/' -%}
  {%- assign category_url = category_path | absolute_url -%}
  {%- endif -%}
{%- endif -%}

  {%- if page.subcluster and category_url -%}
  {%- assign cleaned_sub = page.subcluster | downcase | slugify | strip -%}
  {%- assign subkey = category_key | append: ':' | append: cleaned_sub -%}
  {%- assign mapped_sub = site.data.subcluster_slugs[subkey] | default: nil -%}
  {%- if mapped_sub -%}
    {%- assign subcluster_url = mapped_sub | absolute_url -%}
  {%- else -%}
    {%- comment -%} fallback: always build under /categorie/{category}/{subcluster}/ {%- endcomment -%}
  {%- assign sub_path = '/categorie/' | append: category_key | append: '/' | append: cleaned_sub | append: '/' -%}
  {%- assign subcluster_url = sub_path | absolute_url -%}
  {%- endif -%}
{%- endif -%}

<!-- BreadcrumbList Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {%- assign pos = 1 -%}
    {
      "@type": "ListItem",
      "position": {{ pos }},
      "name": "Home",
      "item": "{{ site.url | strip_newlines | strip }}"
    }
    {%- if category_url -%},{% assign pos = pos | plus: 1 %}
    {
      "@type": "ListItem",
      "position": {{ pos }},
      "name": "{{ page.categories.first | capitalize }}",
      "item": "{{ category_url | strip_newlines | strip }}"
    }
    {%- endif -%}
    {%- if subcluster_url -%},{% assign pos = pos | plus: 1 %}
    {
      "@type": "ListItem",
      "position": {{ pos }},
      "name": "{{ page.subcluster | replace: '-', ' ' | capitalize }}",
      "item": "{{ subcluster_url | strip_newlines | strip }}"
    }
    {%- endif -%},{% assign pos = pos | plus: 1 %}
    {
      "@type": "ListItem",
      "position": {{ pos }},
      "name": "{{ page.title | escape }}",
      "item": "{{ page.url | absolute_url | strip_newlines | strip }}"
    }
  ]
}
</script>

{% if page.collection_posts and page.collection_posts.size > 0 %}
<!-- CollectionPage + ItemList Schema (per pagine categoria) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": "{{ page.url | absolute_url }}#collectionpage",
  "name": "{{ page.title }}",
  "description": "{{ page.description }}",
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": {{ page.collection_posts.size }},
    "itemListElement": [
      {% for post in page.collection_posts limit: 10 %}
      {
        "@type": "ListItem",
        "position": {{ forloop.index }},
        "url": "{{ post.url | absolute_url }}",
        "name": "{{ post.title }}"
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
}
</script>
{% endif %}

{% endif %}

name: Lighthouse CI Production

on:
  workflow_dispatch:
  push:
    branches:
      - feat/layout-category-subcluster
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday 2 AM

jobs:
  lhci:
    name: Lighthouse CI - 5 Mobile Runs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup Chrome (bypass snap)
        uses: browser-actions/setup-chrome@v1
        id: setup-chrome
        with:
          chrome-version: stable
      
      - name: Display Chrome version
        run: |
          echo "Chrome installed at: ${{ steps.setup-chrome.outputs.chrome-path }}"
          ${{ steps.setup-chrome.outputs.chrome-path }} --version
      
      - name: Display Node version
        run: node --version
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Lighthouse CI
        run: npx lhci autorun --config=lighthouserc.json
        env:
          CHROME_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
      
      - name: Copy reports with timestamp
        if: always()
        run: |
          TIMESTAMP=$(date +%Y-%m-%d)
          mkdir -p docs/evidence/lighthouse/$TIMESTAMP
          
          # Copy all HTML and JSON reports
          if [ -d ".lighthouseci" ]; then
            cp .lighthouseci/*.html docs/evidence/lighthouse/$TIMESTAMP/ 2>/dev/null || true
            cp .lighthouseci/*.json docs/evidence/lighthouse/$TIMESTAMP/ 2>/dev/null || true
            
            echo "âœ… Reports copied to docs/evidence/lighthouse/$TIMESTAMP/"
            ls -lh docs/evidence/lighthouse/$TIMESTAMP/
          else
            echo "âš ï¸ No .lighthouseci directory found"
          fi
      
      - name: Upload Lighthouse reports as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports-${{ github.run_number }}
          path: .lighthouseci/
          retention-days: 30
      
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Lighthouse CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Node**: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "**Chrome**: $(${{ steps.setup-chrome.outputs.chrome-path }} --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs Tested (5 mobile runs each)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ  [Home](https://messymind.it/)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‚ [Category Burnout](https://messymind.it/categorie/burnout-e-lavoro/)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ [Post Stress](https://messymind.it/2025/09/29/stress-correlato/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: â‰¥ 80" >> $GITHUB_STEP_SUMMARY
          echo "- SEO: â‰¥ 95" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility: â‰¥ 90" >> $GITHUB_STEP_SUMMARY
          echo "- Best Practices: â‰¥ 90" >> $GITHUB_STEP_SUMMARY
          echo "- CLS: â‰¤ 0.1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Download reports**: Check Artifacts section below" >> $GITHUB_STEP_SUMMARY

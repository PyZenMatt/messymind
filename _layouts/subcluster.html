---
layout: default
---
{%- assign cluster = nil -%}
{%- if page.category -%}
  {%- assign cluster = page.category | downcase | replace: ' ', '-' | strip -%}
{%- elsif page.categories and page.categories.first -%}
  {%- assign cluster = page.categories.first | downcase | replace: ' ', '-' | strip -%}
{%- endif -%}
{%- assign sub = page.subcluster | downcase | replace: ' ', '-' | strip -%}

{%- comment -%}
  Recupero post del sotto-cluster in modo robusto:
  - normalizza il valore `sub` e confronta con `post.subcluster` normalizzato
  - se la pagina definisce `category` (cluster) filtra anche per quella categoria
  - ordina per data decrescente
{%- endcomment -%}

{%- assign scoped = '' | split: ',' -%}
{%- for p in site.posts -%}
  {%- assign p_sub = p.subcluster | default: '' | downcase | replace: ' ', '-' | strip -%}
  {%- if p_sub == sub -%}
    {%- if cluster == nil or cluster == '' or p.categories contains cluster -%}
      {%- assign scoped = scoped | push: p -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Ordina per data decrescente {%- endcomment -%}
{%- assign scoped = scoped | sort: 'date' | reverse -%}

{%- comment -%}
  Costruisco lista `corner` (guide essenziali) prendendo i post in `scoped` con flag/tag cornerstone
{%- endcomment -%}
{%- assign corner = '' | split: ',' -%}
{%- for p in scoped -%}
  {%- if p.is_cornerstone == true or p.is_cornerstone == 'true' or p.cornerstone == true or p.cornerstone == 'true' -%}
    {%- assign corner = corner | push: p -%}
  {%- else -%}
    {%- if p.tags -%}
      {%- assign tagstr = p.tags | join: '|' | downcase -%}
      {%- if tagstr contains 'cornerstone' -%}
        {%- assign corner = corner | push: p -%}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}
{%- assign corner = corner | uniq -%}

{%- comment -%}
  Expose collection_posts for global schema includes and possible pagination
{%- endcomment -%}
{%- assign page.collection_posts = scoped -%}

  <section class="cornerstones mb-4">
    <h2>Guide essenziali</h2>
    <ul class="cards list-unstyled d-flex flex-column gap-3">
    {%- if page.description -%}<p class="intro">{{ page.description }}</p>{%- elsif page.intro -%}<p class="intro">{{ page.intro }}</p>{%- endif -%}
      {%- for post in corner -%}
        <li class="card p-3">
          <a href="{{ post.url | relative_url }}" class="text-decoration-none text-dark">
            <h3 class="h5 mb-1">{{ post.title }}</h3>
            <p class="mb-0">{{ post.description }}</p>
          </a>
        </li>
      {%- endfor -%}
    </ul>
  </section>

  <section class="listing mb-4">
    <h2>Tutti gli articoli</h2>

    {%- comment -%}
      Opzione A: senza plugin, mostra gli ultimi N
    {%- endcomment -%}
    {%- assign posts_to_show = scoped -%}
    {%- if site.paginate_subcluster != true -%}
      {%- assign posts_to_show = scoped | slice: 0, 24 -%}
    {%- endif -%}

    <ul class="cards list-unstyled">
      {%- for post in posts_to_show -%}
        <li class="card mb-3 p-3">
          <a href="{{ post.url | relative_url }}" class="text-decoration-none text-dark">
            <h3 class="h6 mb-1">{{ post.title }}</h3>
            <p class="mb-1">{{ post.description }}</p>
          </a>
          <small class="text-muted">{{ post.date | date: "%-d %b %Y" }}</small>
        </li>
      {%- endfor -%}
    </ul>

    {%- comment -%}
      Opzione B: con jekyll-paginate-v2 su una collezione virtuale
    {%- endcomment -%}
  </section>

  {%- if page.faq and page.faq.size > 0 -%}
  <section class="faq mb-4">
    <h2>FAQ</h2>
    {%- for item in page.faq -%}
      <details class="mb-2">
        <summary>{{ item.q }}</summary>
        <p class="mb-0">{{ item.a }}</p>
      </details>
    {%- endfor -%}
  </section>
  {%- endif -%}

  {%- comment -%}
    JSON-LD: BreadcrumbList + CollectionPage con ItemList
  {%- endcomment -%}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "item": { "@id": "{{ "/" | absolute_url }}", "name": "Home" }, "position": 1 },
      {%- comment -%}
        Resolve canonical category URL: prefer mapping in site.data.category_slugs, otherwise build under /categorie/
      {%- endcomment -%}
      {%- assign category_key = cluster -%}
      {%- assign mapped_cat = site.data.category_slugs[category_key] | default: nil -%}
      {%- if mapped_cat -%}
        {%- assign category_id = mapped_cat | absolute_url -%}
      {%- else -%}
        {%- assign category_id = site.url | append: '/categorie/' | append: category_key | append: '/' -%}
      {%- endif -%}
      { "item": { "@id": "{{ category_id }}", "name": "{{ page.cluster_name | default: cluster | capitalize }}" }, "position": 2 },
      {%- if page.subcluster -%}
        {%- assign cleaned_sub = page.subcluster | downcase | replace: ' ', '-' | strip -%}
        {%- assign sub_key = category_key | append: ':' | append: cleaned_sub -%}
        {%- assign mapped_sub = site.data.subcluster_slugs[sub_key] | default: nil -%}
        {%- if mapped_sub -%}
          {%- assign sub_id = mapped_sub | absolute_url -%}
        {%- else -%}
          {%- assign sub_id = site.url | append: '/categorie/' | append: category_key | append: '/' | append: cleaned_sub | append: '/' -%}
        {%- endif -%}
        { "item": { "@id": "{{ sub_id }}", "name": "{{ page.subcluster | replace: '-', ' ' | capitalize }}" }, "position": 3 },
        { "item": { "@id": "{{ page.url | absolute_url }}", "name": "{{ page.title | escape }}" }, "position": 4 }
      {%- else -%}
        { "item": { "@id": "{{ page.url | absolute_url }}", "name": "{{ page.title | escape }}" }, "position": 3 }
      {%- endif -%}
    ]
  }
  </script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "{{ page.seo_title | default: page.title | escape }}",
    "description": "{{ page.meta_description | default: page.description | escape }}",
    "mainEntity": {
      "@type": "ItemList",
      "itemListElement": [
        {%- for post in scoped limit:24 -%}
        {
          "@type": "ListItem",
          "position": {{ forloop.index }},
          "url": "{{ post.url | absolute_url }}",
          "name": "{{ post.title | escape }}"
        }{%- if forloop.last == false -%},{%- endif -%}
        {%- endfor -%}
      ]
    }
  }
  </script>
</div>

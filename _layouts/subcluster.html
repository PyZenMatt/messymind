---
layout: default
---
{%- assign cluster = nil -%}
{%- if page.category and page.category != '' -%}
  {%- assign cluster = page.category | downcase | slugify | strip -%}
{%- elsif page.categories and page.categories.size > 0 and page.categories[0] != '' -%}
  {%- assign cluster = page.categories[0] | downcase | slugify | strip -%}
{%- elsif page.cluster and page.cluster != '' -%}
  {%- assign cluster = page.cluster | downcase | slugify | strip -%}
{%- elsif page.cluster_name and page.cluster_name != '' -%}
  {%- assign cluster = page.cluster_name | downcase | slugify | strip -%}
{%- endif -%}
{%- assign sub = page.subcluster | default: '' | downcase | slugify | strip -%}

{%- comment -%} Build scoped posts robustly, normalizing categories {%- endcomment -%}
{%- assign scoped = '' | split: ',' -%}
{%- for p in site.posts -%}
  {%- assign p_sub = p.subcluster | default: '' | downcase | slugify | strip -%}
  {%- if p_sub == sub -%}
    {%- if cluster -%}
      {%- assign in_cat = false -%}
      {%- if p.categories -%}
        {%- assign cats = p.categories -%}
        {%- if cats contains ',' -%}
          {%- assign cats = cats | split: ',' -%}
        {%- endif -%}
        {%- if cats and cats[0] == nil -%}
          {%- assign cats = cats | split: '|' -%}
        {%- endif -%}
        {%- for c in cats -%}
          {%- assign ckey = c | downcase | slugify | strip -%}
          {%- if ckey == cluster -%}
            {%- assign in_cat = true -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
      {%- if in_cat -%}
        {%- assign scoped = scoped | push: p -%}
      {%- endif -%}
    {%- else -%}
      {%- assign scoped = scoped | push: p -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}
{%- assign scoped = scoped | sort: 'date' | reverse -%}

{%- comment -%} Collect cornerstones from scoped (robust checks) {%- endcomment -%}
{%- assign corner = '' | split: ',' -%}
{%- for p in scoped -%}
  {%- assign is_corner = false -%}
  {%- if p.is_cornerstone == true or p.is_cornerstone == 'true' -%}{%- assign is_corner = true -%}{%- endif -%}
  {%- if p.cornerstone == true or p.cornerstone == 'true' -%}{%- assign is_corner = true -%}{%- endif -%}
  {%- if p.tags -%}
    {%- if p.tags contains 'cornerstone' -%}
      {%- assign is_corner = true -%}
    {%- else -%}
      {%- assign tagstr = p.tags | join: '|' | downcase -%}
      {%- if tagstr contains 'cornerstone' -%}{%- assign is_corner = true -%}{%- endif -%}
    {%- endif -%}
  {%- endif -%}
  {%- if is_corner -%}{%- assign corner = corner | push: p -%}{%- endif -%}
{%- endfor -%}

<div class="mt-4">
  <div class="row">
    <div class="col-12">

      <h1 class="h3 mb-2">{{ page.title | default: page.subcluster | replace: '-', ' ' | capitalize }}</h1>

      {%- if page.description -%}
        <p class="lead text-muted mb-3">{{ page.description }}</p>
      {%- elsif page.intro -%}
        <p class="lead text-muted mb-3">{{ page.intro }}</p>
      {%- endif -%}

      <!-- Cornerstones (simple list) -->
      {% if corner and corner.size > 0 %}
      <section class="cornerstones mb-4">
        <h2>Guide essenziali</h2>
        <ul class="list-unstyled mb-0">
          {% for post in corner %}
            <li class="mb-3">
              <a href="{{ post.url | relative_url }}" class="text-decoration-none text-dark">
                <strong>{{ post.title }}</strong>
              </a>
              {% if post.description %}
                <div class="text-muted small">{{ post.description }}</div>
              {% endif %}
              <div><small class="text-muted">{{ post.date | date: '%d/%m/%Y' }}</small></div>
            </li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}

      <!-- Listing -->
      <section class="listing mb-4">
        <h2>Tutti gli articoli</h2>

        {%- assign posts_to_show = scoped -%}

        {%- if corner and corner.size > 0 -%}
          {%- assign filtered = '' | split: ',' -%}
          {%- for p in posts_to_show -%}
            {%- unless corner contains p -%}
              {%- assign filtered = filtered | push: p -%}
            {%- endunless -%}
          {%- endfor -%}
          {%- assign posts_to_show = filtered -%}
        {%- endif -%}

        {%- if site.paginate_subcluster != true -%}
          {%- assign posts_to_show = posts_to_show | slice: 0, 24 -%}
        {%- endif -%}

        <ul class="cards list-unstyled">
          {%- for post in posts_to_show -%}
            <li class="card mb-3 p-3">
              <a href="{{ post.url | relative_url }}" class="text-decoration-none text-dark">
                <h3 class="h6 mb-1">{{ post.title }}</h3>
                <p class="mb-1">{{ post.description }}</p>
              </a>
              <small class="text-muted">{{ post.date | date: "%-d %b %Y" }}</small>
            </li>
          {%- endfor -%}
        </ul>
      </section>

      {%- if page.faq and page.faq.size > 0 -%}
      <section class="faq mb-4">
        <h2>FAQ</h2>
        {%- for item in page.faq -%}
          <details class="mb-2">
            <summary>{{ item.q }}</summary>
            <p class="mb-0">{{ item.a }}</p>
          </details>
        {%- endfor -%}
      </section>
      {%- endif -%}

      <!-- JSON-LD BreadcrumbList -->
      <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
          { "item": { "@id": "{{ "/" | absolute_url }}", "name": "Home" }, "position": 1 },
          {%- assign category_key = cluster -%}
          {%- assign mapped_cat = site.data.category_slugs[category_key] | default: nil -%}
          {%- if mapped_cat -%}
            {%- assign category_id = mapped_cat | absolute_url -%}
          {%- else -%}
            {%- assign category_id = site.url | append: '/categorie/' | append: category_key | append: '/' -%}
          {%- endif -%}
          { "item": { "@id": "{{ category_id }}", "name": "{{ page.cluster_name | default: cluster | capitalize }}" }, "position": 2 },
          {%- if page.subcluster -%}
            {%- assign cleaned_sub = page.subcluster | downcase | slugify | strip -%}
            {%- assign sub_key = category_key | append: ':' | append: cleaned_sub -%}
            {%- assign mapped_sub = site.data.subcluster_slugs[sub_key] | default: nil -%}
            {%- if mapped_sub -%}
              {%- assign sub_id = mapped_sub | absolute_url -%}
            {%- else -%}
              {%- assign sub_id = site.url | append: '/categorie/' | append: category_key | append: '/' | append: cleaned_sub | append: '/' -%}
            {%- endif -%}
            { "item": { "@id": "{{ sub_id }}", "name": "{{ page.subcluster | replace: '-', ' ' | capitalize }}" }, "position": 3 },
            { "item": { "@id": "{{ page.url | absolute_url }}", "name": "{{ page.title | escape }}" }, "position": 4 }
          {%- else -%}
            { "item": { "@id": "{{ page.url | absolute_url }}", "name": "{{ page.title | escape }}" }, "position": 3 }
          {%- endif -%}
        ]
      }
      </script>

      <!-- JSON-LD CollectionPage -->
      <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "CollectionPage",
        "name": "{{ page.seo_title | default: page.title | escape }}",
        "description": "{{ page.meta_description | default: page.description | escape }}",
        "mainEntity": {
          "@type": "ItemList",
          "itemListElement": [
            {%- for post in scoped limit:24 -%}
            {
              "@type": "ListItem",
              "position": {{ forloop.index }},
              "url": "{{ post.url | absolute_url }}",
              "name": "{{ post.title | escape }}"
            }{%- if forloop.last == false -%},{%- endif -%}
            {%- endfor -%}
          ]
        }
      }
      </script>

    </div>
  </div>
</div>
